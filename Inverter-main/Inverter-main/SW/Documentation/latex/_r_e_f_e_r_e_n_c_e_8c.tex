\doxysection{C\+:/\+Users/dwegg/\+Desktop/\+Inverter/\+SW/\+Inverter/\+Core/\+Src/\+REFERENCE.c File Reference}
\hypertarget{_r_e_f_e_r_e_n_c_e_8c}{}\label{_r_e_f_e_r_e_n_c_e_8c}\index{C:/Users/dwegg/Desktop/Inverter/SW/Inverter/Core/Src/REFERENCE.c@{C:/Users/dwegg/Desktop/Inverter/SW/Inverter/Core/Src/REFERENCE.c}}


Source file for torque reference handling.  


{\ttfamily \#include "{}REFERENCE.\+h"{}}\newline
{\ttfamily \#include $<$math.\+h$>$}\newline
Include dependency graph for REFERENCE.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c__incl}
\end{center}
\end{figure}
\doxysubsubsection*{Functions}
\begin{DoxyCompactItemize}
\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_a1988c289dd46fd505e0f9de30044fed0}{handle\+\_\+torque\+Ref}} (float torque\+Ref\+In, int8\+\_\+t direction, float torque\+Max, float speed\+Max\+RPM, float speed\+Meas, volatile pi\+\_\+struct \texorpdfstring{$\ast$}{*}loop\+Speed)
\begin{DoxyCompactList}\small\item\em Handles torque control based on the reference torque, direction, maximum torque, maximum speed, measured speed, maximum torque rate of change, speed control loop parameters, and sampling time. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_ab120f5abe0a9a818f3926bc3a859abd6}{set\+\_\+torque\+\_\+direction}} (float torque\+Ref\+In, int8\+\_\+t direction)
\begin{DoxyCompactList}\small\item\em Set torque direction based on inverter direction. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_a0f5d51160e9eb91ad3ffba1c5905eed6}{saturate\+\_\+symmetric}} (float ref, float max)
\begin{DoxyCompactList}\small\item\em Symmetrically saturate a reference value. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_a0da21f1ac59fa2f2ff67acfd930147ed}{limit\+\_\+torque\+\_\+to\+\_\+prevent\+\_\+overspeed}} (float speed\+Max\+RPM, float speed\+Meas, float torque\+Ref\+In, volatile pi\+\_\+struct \texorpdfstring{$\ast$}{*}loop\+Speed)
\begin{DoxyCompactList}\small\item\em Speed loop acts as a torque saturation, reducing torque in order to limit the maximum speed. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_ab28157c98105fc7d3bbb3dc65e7d5eda}{calculate\+\_\+derated\+\_\+current}} (float temperature, float temp\+Start, float temp\+Max, float i\+Max)
\begin{DoxyCompactList}\small\item\em Calculate derated current based on temperature thresholds. It implements a simple linear derating from temp\+Start to temp\+Max. \end{DoxyCompactList}\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_ad1767fbcd06a25a3c5d6db9c033c2a0f}{derate\+\_\+current\+\_\+reference}} (float temp\+Motor, float temp\+Inverter, float i\+Max)
\begin{DoxyCompactList}\small\item\em Derate the current reference based on both motor and inverter temperatures. \end{DoxyCompactList}\end{DoxyCompactItemize}
\doxysubsubsection*{Variables}
\begin{DoxyCompactItemize}
\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_a4497f9492ddec5b5db380c2528b2cb74}{torque\+Ref\+In\+\_\+left}} = 0.\+0F
\item 
float \mbox{\hyperlink{_r_e_f_e_r_e_n_c_e_8c_ad5e47b5d0477a6ed28fb07be19874289}{torque\+Ref\+In\+\_\+right}} = 0.\+0F
\end{DoxyCompactItemize}


\doxysubsection{Detailed Description}
Source file for torque reference handling. 

\begin{DoxyAttention}{Attention}

\end{DoxyAttention}
Copyright (c) 2024 David Redondo (@dweggg in Git\+Hub). All rights reserved.

This software is licensed under the Attribution-\/\+Non\+Commercial-\/\+Share\+Alike 4.\+0 International (CC BY-\/\+NC-\/\+SA 4.\+0) license. For more information, see\+: \href{https://creativecommons.org/licenses/by-nc-sa/4.0/legalcode}{\texttt{ https\+://creativecommons.\+org/licenses/by-\/nc-\/sa/4.\+0/legalcode}} 

\doxysubsection{Function Documentation}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_ab28157c98105fc7d3bbb3dc65e7d5eda}\label{_r_e_f_e_r_e_n_c_e_8c_ab28157c98105fc7d3bbb3dc65e7d5eda} 
\index{REFERENCE.c@{REFERENCE.c}!calculate\_derated\_current@{calculate\_derated\_current}}
\index{calculate\_derated\_current@{calculate\_derated\_current}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{calculate\_derated\_current()}{calculate\_derated\_current()}}
{\footnotesize\ttfamily float calculate\+\_\+derated\+\_\+current (\begin{DoxyParamCaption}\item[{float}]{temperature,  }\item[{float}]{temp\+Start,  }\item[{float}]{temp\+Max,  }\item[{float}]{i\+Max }\end{DoxyParamCaption})}



Calculate derated current based on temperature thresholds. It implements a simple linear derating from temp\+Start to temp\+Max. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em temperature} & The current temperature. \\
\hline
\mbox{\texttt{ in}}  & {\em temp\+Start} & The temperature at which derating starts. \\
\hline
\mbox{\texttt{ in}}  & {\em temp\+Max} & The temperature at which the current is fully derated to 0. \\
\hline
\mbox{\texttt{ in}}  & {\em i\+Max} & The maximum current.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The derated current. 
\end{DoxyReturn}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_ab28157c98105fc7d3bbb3dc65e7d5eda_icgraph}
\end{center}
\end{figure}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_ad1767fbcd06a25a3c5d6db9c033c2a0f}\label{_r_e_f_e_r_e_n_c_e_8c_ad1767fbcd06a25a3c5d6db9c033c2a0f} 
\index{REFERENCE.c@{REFERENCE.c}!derate\_current\_reference@{derate\_current\_reference}}
\index{derate\_current\_reference@{derate\_current\_reference}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{derate\_current\_reference()}{derate\_current\_reference()}}
{\footnotesize\ttfamily float derate\+\_\+current\+\_\+reference (\begin{DoxyParamCaption}\item[{float}]{temp\+Motor,  }\item[{float}]{temp\+Inverter,  }\item[{float}]{i\+Max }\end{DoxyParamCaption})}



Derate the current reference based on both motor and inverter temperatures. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em temp\+Motor} & The motor temperature. \\
\hline
\mbox{\texttt{ in}}  & {\em temp\+Inverter} & The inverter temperature. \\
\hline
\mbox{\texttt{ in}}  & {\em i\+Max} & The maximum current.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The derated current reference. 
\end{DoxyReturn}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_ad1767fbcd06a25a3c5d6db9c033c2a0f_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_ad1767fbcd06a25a3c5d6db9c033c2a0f_icgraph}
\end{center}
\end{figure}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_a1988c289dd46fd505e0f9de30044fed0}\label{_r_e_f_e_r_e_n_c_e_8c_a1988c289dd46fd505e0f9de30044fed0} 
\index{REFERENCE.c@{REFERENCE.c}!handle\_torqueRef@{handle\_torqueRef}}
\index{handle\_torqueRef@{handle\_torqueRef}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{handle\_torqueRef()}{handle\_torqueRef()}}
{\footnotesize\ttfamily float handle\+\_\+torque\+Ref (\begin{DoxyParamCaption}\item[{float}]{torque\+Ref\+In,  }\item[{int8\+\_\+t}]{direction,  }\item[{float}]{torque\+Max,  }\item[{float}]{speed\+Max\+RPM,  }\item[{float}]{speed\+Meas,  }\item[{volatile pi\+\_\+struct \texorpdfstring{$\ast$}{*}}]{loop\+Speed }\end{DoxyParamCaption})}



Handles torque control based on the reference torque, direction, maximum torque, maximum speed, measured speed, maximum torque rate of change, speed control loop parameters, and sampling time. 


\begin{DoxyParams}{Parameters}
{\em torque\+Ref\+In} & Input reference torque. \\
\hline
{\em direction} & Direction of torque (1 for positive torque, -\/1 for negative torque). \\
\hline
{\em torque\+Max} & Maximum allowable torque. \\
\hline
{\em speed\+Max\+RPM} & Maximum allowable speed in RPM. \\
\hline
{\em speed\+Meas} & Measured speed. \\
\hline
{\em loop\+Speed} & Speed control loop parameters.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The output torque after handling direction, saturation, and rate limiting. 
\end{DoxyReturn}
Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=323pt]{_r_e_f_e_r_e_n_c_e_8c_a1988c289dd46fd505e0f9de30044fed0_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_a1988c289dd46fd505e0f9de30044fed0_icgraph}
\end{center}
\end{figure}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_a0da21f1ac59fa2f2ff67acfd930147ed}\label{_r_e_f_e_r_e_n_c_e_8c_a0da21f1ac59fa2f2ff67acfd930147ed} 
\index{REFERENCE.c@{REFERENCE.c}!limit\_torque\_to\_prevent\_overspeed@{limit\_torque\_to\_prevent\_overspeed}}
\index{limit\_torque\_to\_prevent\_overspeed@{limit\_torque\_to\_prevent\_overspeed}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{limit\_torque\_to\_prevent\_overspeed()}{limit\_torque\_to\_prevent\_overspeed()}}
{\footnotesize\ttfamily float limit\+\_\+torque\+\_\+to\+\_\+prevent\+\_\+overspeed (\begin{DoxyParamCaption}\item[{float}]{speed\+Max\+RPM,  }\item[{float}]{speed\+Meas,  }\item[{float}]{torque\+Ref\+In,  }\item[{volatile pi\+\_\+struct \texorpdfstring{$\ast$}{*}}]{loop\+Speed }\end{DoxyParamCaption})}



Speed loop acts as a torque saturation, reducing torque in order to limit the maximum speed. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em speed\+Max\+RPM} & The maximum speed value in RPM. \\
\hline
\mbox{\texttt{ in}}  & {\em speed\+Meas} & The measured speed value in RPM. \\
\hline
\mbox{\texttt{ in}}  & {\em torque\+Ref\+In} & The torque reference value before this saturation. \\
\hline
\mbox{\texttt{ in}}  & {\em loop\+Speed} & Pointer to the speed PI controller structure. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
torque\+Ref\+Out The limited torque reference value after this saturation. 
\end{DoxyReturn}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_a0da21f1ac59fa2f2ff67acfd930147ed_icgraph}
\end{center}
\end{figure}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_a0f5d51160e9eb91ad3ffba1c5905eed6}\label{_r_e_f_e_r_e_n_c_e_8c_a0f5d51160e9eb91ad3ffba1c5905eed6} 
\index{REFERENCE.c@{REFERENCE.c}!saturate\_symmetric@{saturate\_symmetric}}
\index{saturate\_symmetric@{saturate\_symmetric}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{saturate\_symmetric()}{saturate\_symmetric()}}
{\footnotesize\ttfamily float saturate\+\_\+symmetric (\begin{DoxyParamCaption}\item[{float}]{ref,  }\item[{float}]{max }\end{DoxyParamCaption})}



Symmetrically saturate a reference value. 

This function symmetrically saturates a reference value based on the maximum allowed value. If the reference value exceeds the maximum allowed value, it is saturated to the maximum value. If the reference value is less than the negative of the maximum allowed value, it is saturated to the negative of the maximum value.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em ref} & The reference value to saturate. \\
\hline
\mbox{\texttt{ in}}  & {\em max} & The maximum allowed value for saturation. \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
The saturated reference value. 
\end{DoxyReturn}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_a0f5d51160e9eb91ad3ffba1c5905eed6_icgraph}
\end{center}
\end{figure}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_ab120f5abe0a9a818f3926bc3a859abd6}\label{_r_e_f_e_r_e_n_c_e_8c_ab120f5abe0a9a818f3926bc3a859abd6} 
\index{REFERENCE.c@{REFERENCE.c}!set\_torque\_direction@{set\_torque\_direction}}
\index{set\_torque\_direction@{set\_torque\_direction}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{set\_torque\_direction()}{set\_torque\_direction()}}
{\footnotesize\ttfamily float set\+\_\+torque\+\_\+direction (\begin{DoxyParamCaption}\item[{float}]{torque\+Ref\+In,  }\item[{int8\+\_\+t}]{direction }\end{DoxyParamCaption})}



Set torque direction based on inverter direction. 

This function adjusts the torque reference based on the desired direction. If the motor is set to rotate counterclockwise (CCW), positive torque represents traction, negative is braking. If the motor is set to rotate clockwise (CW), negative torque represents traction, positive is braking.


\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in}}  & {\em torque\+Ref\+In} & The torque reference value to adjust. \\
\hline
\mbox{\texttt{ in}}  & {\em direction} & Pointer to the direction of the inverter (1 for CW, -\/1 for CCW). \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
torque\+Ref\+Out The adjusted torque reference value. 
\end{DoxyReturn}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{_r_e_f_e_r_e_n_c_e_8c_ab120f5abe0a9a818f3926bc3a859abd6_icgraph}
\end{center}
\end{figure}


\doxysubsection{Variable Documentation}
\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_a4497f9492ddec5b5db380c2528b2cb74}\label{_r_e_f_e_r_e_n_c_e_8c_a4497f9492ddec5b5db380c2528b2cb74} 
\index{REFERENCE.c@{REFERENCE.c}!torqueRefIn\_left@{torqueRefIn\_left}}
\index{torqueRefIn\_left@{torqueRefIn\_left}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{torqueRefIn\_left}{torqueRefIn\_left}}
{\footnotesize\ttfamily float torque\+Ref\+In\+\_\+left = 0.\+0F}

\Hypertarget{_r_e_f_e_r_e_n_c_e_8c_ad5e47b5d0477a6ed28fb07be19874289}\label{_r_e_f_e_r_e_n_c_e_8c_ad5e47b5d0477a6ed28fb07be19874289} 
\index{REFERENCE.c@{REFERENCE.c}!torqueRefIn\_right@{torqueRefIn\_right}}
\index{torqueRefIn\_right@{torqueRefIn\_right}!REFERENCE.c@{REFERENCE.c}}
\doxysubsubsection{\texorpdfstring{torqueRefIn\_right}{torqueRefIn\_right}}
{\footnotesize\ttfamily float torque\+Ref\+In\+\_\+right = 0.\+0F}

